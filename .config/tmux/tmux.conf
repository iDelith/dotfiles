# Fix terminal color problems correctly infer colors from ANSI colors
set -g default-terminal "tmux-256color"

# Prefix key customization
#unbind C-b
#set -g prefix C-t
#bind C-t send-prefix

# Enable vi mode for copy mode
setw -g mode-keys vi

# Bind key for entering copy mode (default is prefix+[)
bind-key v copy-mode

# Vi-like selection and copying in copy mode
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'V' send -X select-line
bind-key -T copy-mode-vi 'C-v' send -X rectangle-toggle

# Vi-like yanking - copy to both tmux buffer and system clipboard
bind-key -T copy-mode-vi 'y' send -X copy-pipe-and-cancel 'pbcopy'  # macOS

# Vi-like movement keys (these should work by default with mode-keys vi, but explicit bindings)
bind-key -T copy-mode-vi 'h' send -X cursor-left
bind-key -T copy-mode-vi 'j' send -X cursor-down
bind-key -T copy-mode-vi 'k' send -X cursor-up
bind-key -T copy-mode-vi 'l' send -X cursor-right

# Page navigation like vim
bind-key -T copy-mode-vi 'C-f' send -X page-down
bind-key -T copy-mode-vi 'C-b' send -X page-up
bind-key -T copy-mode-vi 'C-d' send -X halfpage-down
bind-key -T copy-mode-vi 'C-u' send -X halfpage-up

# Word navigation like vim
bind-key -T copy-mode-vi 'w' send -X next-word
bind-key -T copy-mode-vi 'b' send -X previous-word
bind-key -T copy-mode-vi 'e' send -X next-word-end

# Line navigation like vim
bind-key -T copy-mode-vi '0' send -X start-of-line
bind-key -T copy-mode-vi '$' send -X end-of-line
bind-key -T copy-mode-vi '^' send -X back-to-indentation

# Search like vim
bind-key -T copy-mode-vi '/' send -X search-forward
bind-key -T copy-mode-vi '?' send -X search-backward
bind-key -T copy-mode-vi 'n' send -X search-again
bind-key -T copy-mode-vi 'N' send -X search-reverse

# Exit copy mode
bind-key -T copy-mode-vi 'q' send -X cancel
bind-key -T copy-mode-vi 'Escape' send -X cancel

# Go to top/bottom like vim
bind-key -T copy-mode-vi 'g' send -X history-top
bind-key -T copy-mode-vi 'G' send -X history-bottom

# Kill session
bind-key K confirm-before -p "kill-session #S? (y/n)" kill-session

# Reload configuration with 'r'
bind-key R source-file ~/.config/tmux/tmux.conf \; display "Reloaded tmux config!"

# Location shortcuts
bind D popup -d "~/dotfiles" -xC -yC -w80% -h80% -E "nvim ."

# Resize panes with Alt+arrows
bind-key -n M-Left resize-pane -L 5
bind-key -n M-Right resize-pane -R 5
bind-key -n M-Up resize-pane -U 5
bind-key -n M-Down resize-pane -D 5

# navi Tmux widger https://github.com/denisidoro/navi/blob/master/docs/widgets/howto/TMUX.md
#bind-key -N "Open Navi (cheat sheets)" -T prefix C-g split-window \
#  "$SHELL --login -i -c 'navi --print | tmux load-buffer -b tmp - ; tmux paste-buffer -p -t {last} -b tmp -d'"
#
#if-shell "test -f ~/.config/tmux/snapshot.conf" "source ~/.config/tmux/snapshot.conf"

# fzf session/window switcher
#bind-key f display-popup -E -h 100% -w 100% "~/.scripts/tmux_fzf_switcher.sh"
#
## Save tmux sessions on some events
#set-hook -g client-detached 'run-shell "~/.scripts/tmux_save_session.sh"'
#set-hook -g session-closed 'run-shell "~/.scripts/tmux_save_session.sh"'
#set-hook -g pane-exited 'run-shell "~/.scripts/tmux_save_session.sh"'

# --------------------------------------------------------------
# TODO: convert this into an independent plugin
# VIM TMUX NAVIGATOR

# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator

vim_pattern='(\S+/)?g?\.?(view|l?n?vim?x?|fzf)(diff)?(-wrapped)?'
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +${vim_pattern}$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'
tmux_version='$(tmux -V | sed -En "s/^tmux ([0-9]+(.[0-9]+)?).*/\1/p")'
if-shell -b '[ "$(echo "$tmux_version < 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\'  'select-pane -l'"
if-shell -b '[ "$(echo "$tmux_version >= 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\\\'  'select-pane -l'"

bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R
bind-key -T copy-mode-vi 'C-\' select-pane -l
# --------------------------------------------------------------


# TMUX CONFIG WRAPPER -- EOF

# List of plugins
# Native
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'

# QOL for sessions
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'

# Auto Reload tmux.conf on file change (source-file ~/.config/tmux/tmux.conf)
set -g @plugin 'b0o/tmux-autoreload'

# Helpful TUI menu for tmux commands (prefix + \)
set -g @plugin 'jaclu/tmux-menus'

# TMUX Sidebar (prefix + Tab || prefix + Backspace)
set -g @plugin 'tmux-plugins/tmux-sidebar'




# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.config/tmux/plugins/tpm/tpm'
